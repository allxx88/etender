<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="–ß–∞—Ç-–±–æ—Ç —Ç–æ—Ä–≥–æ–≤–æ–π –ø–ª–æ—â–∞–¥–∫–∏ ITSTorg">
    <title>ITSTorg AI Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #f18a02;
            --primary-hover: #e07d00;
            --text-color: #333;
            --light-gray: #f5f5f5;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --message-radius: 18px;
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            margin: 0;
            padding: 0;
        }

        #chat-popup {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            max-width: 90vw;
            height: 60vh;
            min-height: 450px;
            max-height: 600px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10000;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        #chat-popup.visible {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            cursor: move;
            user-select: none;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-header button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: var(--light-gray);
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: var(--message-radius);
            max-width: 85%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
            animation: messageIn 0.2s ease;
            position: relative;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background-color: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            background-color: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .chat-input-container {
            display: flex;
            padding: 12px;
            border-top: 1px solid var(--border-color);
            background-color: white;
            align-items: center;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            outline: none;
            font-size: 14px;
            transition: border 0.2s;
        }

        #user-input:focus {
            border-color: var(--primary-color);
        }

        #send-btn {
            margin-left: 10px;
            padding: 12px;
            width: 44px;
            height: 44px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #send-btn:hover {
            background-color: var(--primary-hover);
        }

        #send-btn i {
            font-size: 16px;
        }

        #chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
        }

        #chat-toggle:hover {
            transform: scale(1.1);
            background-color: var(--primary-hover);
        }

        #chat-toggle i {
            font-size: 24px;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background-color: #eee;
            border-radius: var(--message-radius);
            font-style: italic;
            color: #666;
            font-size: 13px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #999;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .timestamp {
            display: block;
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            text-align: right;
        }

        .bot-message .timestamp {
            text-align: left;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è HTML-–∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç –±–æ—Ç–∞ */
        .bot-message a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .bot-message a:hover {
            text-decoration: underline;
        }

        .bot-message ul, .bot-message ol {
            padding-left: 20px;
            margin: 8px 0;
        }

        .bot-message li {
            margin-bottom: 4px;
        }

        .bot-message b, .bot-message strong {
            font-weight: 600;
        }

        .bot-message i, .bot-message em {
            font-style: italic;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 480px) {
            #chat-popup {
                width: 85vw;
                height: 70vh;
                bottom: 10px;
                right: 10px;
                max-height: none;
            }
            
            #chat-toggle {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
            }
            
            .message {
                max-width: 80%;
                font-size: 13px;
                padding: 8px 12px;
            }
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ */
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes popOut {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0; }
        }
    </style>
</head>
<body>
    <button id="chat-toggle" aria-label="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"><i class="fas fa-robot"></i></button>

    <div id="chat-popup">
        <div class="chat-header" id="chat-header">
            <h3><i class="fas fa-robot"></i> ITSTorg AI Assistant</h3>
            <button onclick="toggleChat()" aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç">√ó</button>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="message bot-message">
                –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üòä –Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ç–æ–≤–∞—Ä–Ω—ã–º –ª–æ—Ç–∞–º –∏ —Å–∏—Å—Ç–µ–º–µ –∑–∞–∫—É–ø–æ–∫ —Ç–æ—Ä–≥–æ–≤–æ–π –ø–ª–æ—â–∞–¥–∫–∏ –ò–¢–°–¢–û–†–ì.<br>
                –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –ø–æ–∏—Å–∫–æ–º –ª–æ—Ç–æ–≤, –æ–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã –ø–ª–æ—â–∞–¥–∫–∏ –∏–ª–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã.<br><br>
                –° —á–µ–≥–æ –Ω–∞—á–Ω—ë–º?<span class="timestamp">–¢–æ–ª—å–∫–æ —á—Ç–æ</span>
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." autocomplete="off" aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ">
            <button id="send-btn" onclick="sendMessage()" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞
        const chatState = {
            isTyping: false,
            chatHistory: [],
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
            initialX: 0,
            initialY: 0
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const chatPopup = document.getElementById('chat-popup');
        const chatToggle = document.getElementById('chat-toggle');
        const chatBody = document.getElementById('chat-body');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const chatHeader = document.getElementById('chat-header');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
        function initChat() {
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            const welcomeMsg = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üòä –Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ç–æ–≤–∞—Ä–Ω—ã–º –ª–æ—Ç–∞–º –∏ —Å–∏—Å—Ç–µ–º–µ –∑–∞–∫—É–ø–æ–∫ —Ç–æ—Ä–≥–æ–≤–æ–π –ø–ª–æ—â–∞–¥–∫–∏ –ò–¢–°–¢–û–†–ì. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –ø–æ–∏—Å–∫–æ–º –ª–æ—Ç–æ–≤, –æ–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã –ø–ª–æ—â–∞–¥–∫–∏ –∏–ª–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã. –° —á–µ–≥–æ –Ω–∞—á–Ω—ë–º?";
            chatState.chatHistory.push({ role: "assistant", content: welcomeMsg });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ localStorage, –µ—Å–ª–∏ –µ—Å—Ç—å
            const savedHistory = localStorage.getItem('itstorgChatHistory');
            if (savedHistory) {
                try {
                    chatState.chatHistory = JSON.parse(savedHistory);
                    renderChatHistory();
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:", e);
                }
            }
        }

        // –†–µ–Ω–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
        function renderChatHistory() {
            chatBody.innerHTML = '';
            chatState.chatHistory.forEach(msg => {
                displayMessage(msg.role === 'assistant' ? 'bot' : 'user', msg.content);
            });
            scrollToBottom();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —á–∞—Ç–∞
        function toggleChat() {
            if (chatPopup.classList.contains('visible')) {
                chatPopup.style.animation = 'popOut 0.2s ease';
                setTimeout(() => {
                    chatPopup.classList.remove('visible');
                }, 200);
            } else {
                chatPopup.classList.add('visible');
                chatPopup.style.animation = 'popIn 0.2s ease';
                userInput.focus();
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
        function displayMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            // –î–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ —Ä–∞–∑—Ä–µ—à–∞–µ–º HTML
            if (role === 'bot') {
                messageDiv.innerHTML = content;
            } else {
                // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML
                messageDiv.textContent = content;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º timestamp
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            timestamp.textContent = timeString;
            
            if (role === 'bot') {
                timestamp.style.textAlign = 'left';
            } else {
                timestamp.style.textAlign = 'right';
            }
            
            messageDiv.appendChild(timestamp);
            chatBody.appendChild(messageDiv);
            scrollToBottom();
        }

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        function scrollToBottom() {
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function showTypingIndicator() {
            if (chatState.isTyping) return;
            
            chatState.isTyping = true;
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'message bot-message';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    –ë–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatBody.appendChild(typingDiv);
            scrollToBottom();
        }

        // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            chatState.isTyping = false;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
            displayMessage('user', message);
            chatState.chatHistory.push({ role: "user", content: message });
            userInput.value = '';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
            saveChatHistory();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
            showTypingIndicator();
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥
                const response = await fetch('http://ai.itstorg.ru/generate-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: message,
                        chat_history: chatState.chatHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ —á–∞—Ç
                hideTypingIndicator();
                displayMessage('bot', data.answer);
                chatState.chatHistory.push({ role: "assistant", content: data.answer });
                saveChatHistory();
                
            } catch (error) {
                hideTypingIndicator();
                displayMessage('bot', '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
        function saveChatHistory() {
            try {
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 20 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                if (chatState.chatHistory.length > 20) {
                    chatState.chatHistory = chatState.chatHistory.slice(-20);
                }
                localStorage.setItem('itstorgChatHistory', JSON.stringify(chatState.chatHistory));
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:", e);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        chatToggle.addEventListener('click', toggleChat);
        
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –æ–∫–Ω–∞ —á–∞—Ç–∞
        chatHeader.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);

        function startDrag(e) {
            if (e.target.tagName === 'BUTTON') return;
            
            chatState.isDragging = true;
            chatState.dragStartX = e.clientX;
            chatState.dragStartY = e.clientY;
            chatState.initialX = chatPopup.offsetLeft;
            chatState.initialY = chatPopup.offsetTop;
            chatPopup.style.cursor = 'grabbing';
            chatPopup.style.userSelect = 'none';
        }

        function drag(e) {
            if (!chatState.isDragging) return;
            
            const dx = e.clientX - chatState.dragStartX;
            const dy = e.clientY - chatState.dragStartY;
            
            let newLeft = chatState.initialX + dx;
            let newTop = chatState.initialY + dy;
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–∫–Ω–∞
            newLeft = Math.max(0, Math.min(window.innerWidth - chatPopup.offsetWidth, newLeft));
            newTop = Math.max(0, Math.min(window.innerHeight - chatPopup.offsetHeight, newTop));
            
            chatPopup.style.left = `${newLeft}px`;
            chatPopup.style.top = `${newTop}px`;
            chatPopup.style.right = 'auto';
            chatPopup.style.bottom = 'auto';
        }

        function endDrag() {
            chatState.isDragging = false;
            chatPopup.style.cursor = '';
            chatPopup.style.userSelect = '';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initChat);
    </script>
</body>
</html>